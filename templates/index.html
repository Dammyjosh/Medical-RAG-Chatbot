<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Medical RAG Chatbot</title>
<style>
    :root {
        --bg: #f4f6f8;
        --text: #000;
        --bot-bg: #fff;
        --user-bg: #0d6efd;
        --user-text: #fff;
        --header-bg: #0d6efd;
        --header-text: #fff;
        --border: #ddd;
    }
    body.dark {
        --bg: #1e1e1e;
        --text: #eaeaea;
        --bot-bg: #2a2a2a;
        --user-bg: #4a90e2;
        --user-text: #fff;
        --header-bg: #111;
        --header-text: #eaeaea;
        --border: #444;
    }
    body {
        font-family: 'Segoe UI', sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
        transition: background 0.3s, color 0.3s;
    }
    header {
        background: var(--header-bg);
        color: var(--header-text);
        padding: 1rem;
        font-size: 1.2rem;
        font-weight: bold;
        text-align: center;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #chat {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .message {
        max-width: 75%;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        line-height: 1.4;
        animation: fadeIn 0.3s ease-in-out;
        white-space: pre-wrap;
    }
    .user {
        align-self: flex-end;
        background: var(--user-bg);
        color: var(--user-text);
        border-bottom-right-radius: 4px;
    }
    .bot {
        align-self: flex-start;
        background: var(--bot-bg);
        border: 1px solid var(--border);
        border-bottom-left-radius: 4px;
    }
    #input-bar {
        display: flex;
        padding: 0.75rem;
        background: var(--bot-bg);
        border-top: 1px solid var(--border);
    }
    #question {
        flex: 1;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 1rem;
        background: var(--bg);
        color: var(--text);
    }
    button {
        margin-left: 0.5rem;
        background: var(--user-bg);
        color: var(--user-text);
        border: none;
        padding: 0 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
    }
    button:hover {
        opacity: 0.9;
    }
    .loading {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid var(--border);
        border-top-color: var(--user-bg);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }
    /* Floating Clear Button */
    #clear-chat {
        position: fixed;
        bottom: 80px;
        right: 20px;
        background: crimson;
        color: white;
        border: none;
        padding: 0.6rem 1rem;
        border-radius: 50px;
        font-size: 0.9rem;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        opacity: 0.85;
        transition: opacity 0.2s, transform 0.2s;
    }
    #clear-chat:hover {
        opacity: 1;
        transform: scale(1.05);
    }
</style>
</head>
<body>
<header>
    <span>💬 Medical RAG Chatbot</span>
    <button id="toggle-theme">🌙</button>
</header>
<div id="chat"></div>
<div id="input-bar">
    <input type="text" id="question" placeholder="Ask a medical question..." />
    <button id="send">Send</button>
</div>
<button id="clear-chat">🗑 Clear Chat</button>

<script>
const chat = document.getElementById('chat');
const questionInput = document.getElementById('question');
const sendBtn = document.getElementById('send');
const toggleThemeBtn = document.getElementById('toggle-theme');
const clearChatBtn = document.getElementById('clear-chat');

// Load theme from localStorage
if (localStorage.getItem('theme') === 'dark') {
    document.body.classList.add('dark');
    toggleThemeBtn.textContent = '☀️';
}

// Load chat history
let history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
history.forEach(msg => addMessage(msg.text, msg.sender, false));

function saveHistory() {
    localStorage.setItem('chatHistory', JSON.stringify(history));
}

function addMessage(text, sender, save = true) {
    const msg = document.createElement('div');
    msg.className = `message ${sender}`;
    msg.innerHTML = text;
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
    if (save) {
        history.push({ text, sender });
        saveHistory();
    }
}

function typeMessage(text, sender) {
    const msg = document.createElement('div');
    msg.className = `message ${sender}`;
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;

    let i = 0;
    function typeChar() {
        msg.innerHTML = text.slice(0, i++);
        chat.scrollTop = chat.scrollHeight;
        if (i <= text.length) {
            setTimeout(typeChar, 15);
        }
    }
    typeChar();
    history.push({ text, sender });
    saveHistory();
}

async function sendQuestion() {
    const question = questionInput.value.trim();
    if (!question) return;
    addMessage(question, 'user');
    questionInput.value = '';

    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'message bot';
    loadingMsg.innerHTML = '<span class="loading"></span> Thinking...';
    chat.appendChild(loadingMsg);
    chat.scrollTop = chat.scrollHeight;

    try {
        const backendUrl = window.location.origin + '/ask';
        const res = await fetch(backendUrl,
{
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question })
        });
        const data = await res.json();
        loadingMsg.remove();
        if (data.answer) {
            let answerHtml = `${data.answer}`;
            if (data.sources && data.sources.length) {
                answerHtml += `\n\nSources:\n` +
                    data.sources.map(s => `- ${s.source} [p${s.page}]`).join('\n');
            }
            typeMessage(answerHtml, 'bot');
        } else {
            typeMessage(`*${data.error || '🤔 Hmm, I couldn’t find a confident answer for that. Try rephrasing your question or asking something more specific.'}*`, 'bot');
        }
    } catch (err) {
        loadingMsg.remove();
        typeMessage(`*Error: ${err.message}*`, 'bot');
    }
}

sendBtn.addEventListener('click', sendQuestion);
questionInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') sendQuestion();
});

toggleThemeBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark');
    const darkMode = document.body.classList.contains('dark');
    toggleThemeBtn.textContent = darkMode ? '☀️' : '🌙';
    localStorage.setItem('theme', darkMode ? 'dark' : 'light');
});

clearChatBtn.addEventListener('click', () => {
    if (confirm("Clear the entire chat history?")) {
        history = [];
        saveHistory();
        chat.innerHTML = '';
    }
});
</script>
</body>
</html>